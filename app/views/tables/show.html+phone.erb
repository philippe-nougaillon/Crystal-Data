<h2>Table '<%= @table.name.humanize %>'</h2>

<% if @table.fields.any? %>
	<p>
	  <%= form_tag(request.path, method: :get) do %>
	  	<div class="input-group-lg">

		    Filtre: 
		    <%= text_field_tag :search, params[:search], onchange:'this.form.submit()', class: 'form-control' %>
		    <br>
		    
		    <% @table.fields.filtres.each_with_index do | field,index | %>
			    <%= field.name %>
			    <% default_value = params[:select] ? params[:select][index.to_s] : 'nil' %>
			    <%= select_tag "select[#{index}]", options_for_select(field.values.pluck(:data).uniq, default_value), include_blank:true, onchange:'this.form.submit()', class: 'form-control' %>
			    <br>
			<% end %>
		    <%= submit_tag 'Filtrer', class: 'btn-lg btn-success' %>
			|
			<%= link_to "Ajouter", fill_url(@table.id), class: 'btn-lg btn-primary' %>
			</div>
	  <% end %>
	</p>
	<br>

	<div class="table-responsive">
		<table class="table table-striped table-hover table-bordered">
			<thead>
				<tr>
					<th />
					<% @table.fields.each do | field | %>
						<th>
							<%= link_to_unless field.datatype == 'formule', field.name, url_for(params.merge(sort_by:field.id)) %>
						</th>
					<% end %>
				</tr>
			</thead>

			<% if @records.any? %>
				<tbody>
					<% count = 0 %>	
					<% numeric_types = ['formule','euros','nombre'] %>
					<% @records.each do | index | %>
						<% values = @table.values.records_at(index).order(:record_index,:field_id).pluck(:data) %>
							<% count += 1 %> 
							<tr>
								<td>	
									<%= link_to image_tag('modif.png'), fill_url(@table.id, record_index:index), class:'btn btn-default' %>
								</td>
								<% @table.fields.each_with_index do | field,index | %>
									<td class="<%= numeric_types.include?(field.datatype) ? 'text-right' : '' %>">
										<% if field.datatype == "formule" %>
											<%= field.evaluate(values) %>
										<% elsif field.datatype == "fichier" and values[index] %>
											<%= link_to(values[index].split('__').last, url_for("/table_files/" + values[index])) %>
										<% else %>
											<%= values[index] %>
											<% if field.sum %>
												<% @sum[field.id] += values[index].to_i %>
											<% end %>
										<% end %>
									</td>
								<% end %>
							</tr>
					<% end %>
				</tbody>

				<tfoot>
					<tr>
						<td />
						<% @table.fields.each do |field| %>
							<% if field.sum %>
								<td class="text-right">
									<%= @sum[field.id] %>
								</td>
							<% else %>
								<td />
							<% end %>
						<% end %>
					</tr>
				</tfoot>

			</table>
		</div>	
		<%= count %> sur <%= @table.size %> au total
		<br>
	<% end %>
	<br>
<% end %>
<br><br>
